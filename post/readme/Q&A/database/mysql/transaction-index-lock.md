#### InnoDB 事务、锁、索引 存在什么样的关系？

##### 关于问题
```md
我们很熟悉事务的CAID，InnoDB的锁机制，以及用索引优化查询，它们看似没什么相关性。
但实际上事务和锁的联系是十分紧密的，而索引也会影响加锁机制。
```

##### 回答
###### 事务和锁的关系
```md
1. 如何实现事务的一致性？
事务需要实现一致性，回答事务和锁的关系问题 本质上就是回答 如何保证事务的一致性的问题。

事务的一致性包括数据库内部一致性和外部一致性，外部一致性需要由业务代码来保证，内部一致性由数据库来实现。

事务串行执行的情况下，原子性就可以保证一致性，但并行情况下会不太一样，
当事务提交错执行时，会发生脏读、不可重复读、幻读 这些数据不一致的情况，
需要利用事务的隔离性来保证，就是把事务的执行隔离开，当前执行的事务感知不到其它事务的存在。

2. 那又如何来实现事务的隔离性？
InnoDB 利用不同的 事务隔离级别 解决了脏读、不可重复读、幻读 问题。
实现 不同的事务隔离级别 使用的就是不同的锁机制。
只不过加锁、解锁的过程是由存储引擎实现的，用户感知不到，这就是 隐式锁。

3. 如何实现事务的外部一致性？
上面我们说到 事务的外部一致性是由业务代码实现，实际上需要结合 存储引擎 的显式锁来实现。
需要根据 业务场景 来对数据显式的加锁，事务提交后，统一解锁。

如：经典的转账场景
需要 使用显式锁，同时锁住 转出方 和 转入方 的账户，然后修改账户余额后 再做事务提交。
```

###### 索引和锁的关系
```md
不同的索引采用的锁机制是不一样的，主要区分 唯一索引、非唯一索引、无索引的情况。

唯一索引的情况下，使用记录锁锁住行记录，锁的粒度较小。
非唯一索引的情况下，采用间隙锁，锁住一个范围。
而无索引的情况下，直接锁表。

所以索引不仅提供快速的检索的功能，也影响着数据库的并发度。
```